# üìò Pr√°ctica: Laravel + Docker + Makefile  
## Migraciones y modelos (`estadis` y `equips`)

En esta pr√°ctica vas a aprender a:

- Levantar un proyecto **Laravel** dentro de **Docker** usando un `Makefile`.
- Crear **migraciones** para las tablas `estadis` y `equips`.**Son archivos PHP que definen c√≥mo es la estructura de la base de datos.**
- Ejecutar las migraciones con `make`.
- Crear los **modelos** `Estadi` y `Equip`.**Son clases PHP que representan una tabla de la base de datos.)**

> ‚ÑπÔ∏è Nota: 
Nomenclatura a usar con los Nombres:
- Modelo: singular ‚Üí Equip
- Tabla: plural ‚Üí equips
- Clave for√°nea: singular + _id ‚Üí estadi_id

---

## üß± 0. Visi√≥n general del proyecto

Antes de tocar nada, tienes algo as√≠:

- Un contenedor `app` con Laravel (PHP).
- Un contenedor `db` con MySQL.
- Un contenedor `web` con Nginx.
- Un contenedor `redis`.
- Un contenedor `phpmyadmin`.
- Un `Makefile` que te simplifica la vida.


---

## üöÄ 1. Arrancar el entorno con `make`

Antes de empezar borramos contenedores `sudo docker rm -f $(sudo docker ps -aq)`

En vez de escribir comandos largos de Docker, usaremos el `Makefile`.

Sino hemos instalado Laravel:
```bash
make install
```

En tu proyecto, ejecuta:

```bash
make up
```

Esto:

- Construye las im√°genes si hace falta.
- Levanta todos los contenedores en segundo plano.

Si todo va bien, deber√≠as ver algo como:

- Contenedores levantados: `app`, `db`, `web`, `phpmyadmin`, `redis`.
- Ning√∫n error rojo en la terminal.

Si quieres ver los logs:

```bash
make logs
```

---

## üß∞ 2. El `Makefile` como ‚Äúatajo‚Äù para Artisan

En el proyecto tienes un `Makefile` parecido a este:

```make
artisan:
	@docker compose run --rm app php artisan $(CMD)
	@true
```

Eso significa:

- Cuando haces:

  ```bash
  make artisan CMD="lo-que-sea"
  ```

- En realidad se est√° ejecutando:

  ```bash
  docker compose run --rm app php artisan lo-que-sea
  ```

üí° **Traducci√≥n para clase**:
> Si quieres usar Artisan dentro de Docker ‚Üí **usa siempre `make artisan CMD="..."`**

Ejemplos:

```bash
make artisan CMD="migrate"
make artisan CMD="make:model Estadi"
make artisan CMD="make:migration create_equips_table"
```

---

## üß© 3. Dise√±o de la base de datos

Vamos a trabajar con dos tablas:

- `estadis`
- `equips`

Relaci√≥n:

> Un **estadi** puede tener **muchos equips** 
> Un **equip** pertenece a **un solo estadi**

En t√©rminos de base de datos:

- Tabla `estadis`: tendr√° un campo `id`.
- Tabla `equips`: tendr√° un campo `estadi_id` que es **clave ajena** a `estadis.id`.

---

## üèóÔ∏è 4. Crear las migraciones

### 4.1. Migraci√≥n `create_estadis_table`

Primero, crea la migraci√≥n para `estadis`:

```bash
make artisan CMD="make:migration create_estadis_table"
```

Laravel crear√° un archivo en `database/migrations`, con un nombre parecido a:

```text
2025_12_03_105000_create_estadis_table.php
```

Dentro de ese archivo, completar√°s algo as√≠ (m√°s adelante en clase):

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('estadis', function (Blueprint $table) {
            $table->id();
            $table->string('nom')->unique();
            $table->integer('capacitat');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('estadis');
    }
};
```

---

### 4.2. Migraci√≥n `create_equips_table`

Despu√©s, crea la migraci√≥n para `equips`:

```bash
make artisan CMD="make:migration create_equips_table"
```

Se crear√° un archivo similar a:

```text
2025_12_03_110022_create_equips_table.php
```

M√°s adelante lo editaremos para que quede algo as√≠:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('equips', function (Blueprint $table) {
            $table->id();
            $table->string('nom')->unique();
            $table->foreignId('estadi_id')->constrained();
            $table->integer('titols')->default(0);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
         Schema::dropIfExists('equips');
    }
};
```

---

## ‚è±Ô∏è 5. El orden de las migraciones (muy importante)

Laravel ejecuta las migraciones en el **orden del nombre del archivo**.

Queremos esto:

1. `create_users_table` (las de Laravel por defecto)
2. `create_estadis_table` ‚úÖ
3. `create_equips_table` ‚úÖ

Porque `equips` depende de `estadis` (tiene un `estadi_id`).

‚úîÔ∏è Comprueba en la carpeta `database/migrations` que:

- El archivo `create_estadis_table` tiene una fecha/hora anterior a `create_equips_table`.
- Si no, renombra los archivos con cuidado para que `create_estadi_table` quede por encima.

---

## ‚ñ∂Ô∏è 6. Ejecutar todas las migraciones

Cuando ya tengas las migraciones listas, ejecuta:

```bash
make migrate
```

Esto:

- Crea todas las tablas pendientes en la base de datos.
- Incluye `estadis` y `equips`.

Si usas **phpMyAdmin** (por ejemplo en `http://localhost:8080`):

- Comprueba que existe la base de datos (por ejemplo `futbol`).
- Dentro ver√°s tablas como: `migrations`, `users`, `estadis`, `equips`, etc.

---

## üß± 7. Crear los modelos `Estadi` y `Equip`

Ahora que las tablas existen, vamos a crear los modelos de Eloquent.

### 7.1. Modelo `Estadi`

```bash
make artisan CMD="make:model Estadi"
```

Esto crea `app/Models/Estadi.php`.

Ejemplo de contenido:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

/**
 * MODEL ESTADI
 */
class Estadi extends Model
{
    use HasFactory;

    protected $fillable = ['nom', 'capacitat' ];
    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function equips()
    {
        return $this->hasMany(Equip::class);
    }
}
```

---

### 7.2. Modelo `Equip`

```bash
make artisan CMD="make:model Equip"
```

Esto crea `app/Models/Equip.php`.

Ejemplo de contenido:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

/**
 * Model EQUIP
 */
class Equip extends Model
{
    use HasFactory;

    /**
     * @var string[]
     */
    protected $fillable = ['nom', 'estadi_id', 'titols' ];

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function estadi()
    {
        return $this->belongsTo(Estadi::class);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function manager()
    {
        return $this->hasOne(User::class   );
    }



}
```

---

## ‚úÖ 8. Resumen final para el alumnado

1. **Arrancar el entorno**

   ```bash
   make up
   ```

2. **Crear migraciones**

   ```bash
   make artisan CMD="make:migration create_estadis_table"
   make artisan CMD="make:migration create_equips_table"
   ```

3. **En `database/migrations`** 
   Editar las migraciones para definir bien las tablas y comprobar que 
   `create_estadis_table` se ejecuta **antes** que `create_equips_table`.

4. **Ejecutar migraciones**

   ```bash
   make migrate
   ```

5. **Crear modelos**

   ```bash
   make artisan CMD="make:model Estadi"
   make artisan CMD="make:model Equip"
   ```

6. **(Opcional)** Comprobar tablas en phpMyAdmin y probar las relaciones en Tinker.


# üå±üè≠ 2. Seeders i Factories (Estadis i Equips)

En aquest apartat treballarem amb:

- **Seeders** ‚Üí omplir la BBDD amb dades d‚Äôexemple.
- **Factories** ‚Üí generar dades falses (faker) de manera autom√†tica.
- **DatabaseSeeder** ‚Üí el seeder ‚Äúprincipal‚Äù que crida la resta.

---

## 2.1. Crear Seeders i Factories

En aquest projecte utilitzem Docker + Makefile. 
Creem els seeders i factories amb:

```bash
make artisan CMD="make:seeder EquipsSeeder"
make artisan CMD="make:seeder EstadisSeeder"
make artisan CMD="make:factory EquipFactory"
make artisan CMD="make:factory EstadiFactory"
```

Aquests fitxers es creen a:

- `database/seeders/EquipsSeeder.php`
- `database/seeders/EstadisSeeder.php`
- `database/factories/EquipFactory.php`
- `database/factories/EstadiFactory.php`

---

## 2.2. Models implicats (resum)

Ens assegurem que els models tenen `HasFactory` i les relacions.

### `app/Models/Estadi.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

/**
 * MODEL ESTADI
 */
class Estadi extends Model
{
    use HasFactory;

    protected $fillable = ['nom', 'capacitat'];

    /**
     * Un estadi t√© molts equips
     */
    public function equips()
    {
        return $this->hasMany(Equip::class);
    }
}
```

### `app/Models/Equip.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Database\Factories\EquipFactory;

/**
 * Model EQUIP
 */
class Equip extends Model
{
    use HasFactory;

    protected $fillable = ['nom', 'estadi_id', 'titols'];

    /**
     * Un equip pertany a un estadi
     */
    public function estadi()
    {
        return $this->belongsTo(Estadi::class);
    }

    /**
     * (Opcional) relaci√≥ amb un usuari manager
     */
    public function manager()
    {
        return $this->hasOne(User::class);
    }

    /**
     * Enllacem expl√≠citament amb la factory
     */
    protected static function newFactory()
    {
        return EquipFactory::new();
    }
}
```

---

## 2.3. Completar les Factories

### `database/factories/EstadiFactory.php`

```php
<?php

namespace Database\Factories;

use App\Models\Estadi;
use Illuminate\Database\Eloquent\Factories\Factory;

/**
 * @extends Factory<\App\Models\Estadi>
 */
class EstadiFactory extends Factory
{
    /**
     * Model associat a la factory
     *
     * @var string
     */
    protected $model = Estadi::class;

    /**
     * Estat per defecte
     */
    public function definition(): array
    {
        return [
            'nom'       => $this->faker->unique()->city.' Stadium',
            'capacitat' => $this->faker->numberBetween(10000, 100000),
        ];
    }
}
```

### `database/factories/EquipFactory.php`

```php
<?php

namespace Database\Factories;

use App\Models\Equip;
use App\Models\Estadi;
use Illuminate\Database\Eloquent\Factories\Factory;

/**
 * @extends Factory<\App\Models\Equip>
 */
class EquipFactory extends Factory
{
    /**
     * Model associat a la factory
     *
     * @var string
     */
    protected $model = Equip::class;

    /**
     * Estat per defecte
     */
    public function definition(): array
    {
        return [
            'nom'       => $this->faker->unique()->company,
            'titols'    => $this->faker->numberBetween(0, 50),
            // Crear√† tamb√© un Estadi associat si no en passem cap
            'estadi_id' => Estadi::factory(),
            // 'escut' => 'escuts/dummy.png',
        ];
    }
}
```

---

## 2.4. Completar els Seeders

### `database/seeders/EstadisSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\Estadi;
use Illuminate\Database\Seeder;

class EstadisSeeder extends Seeder
{
    public function run(): void
    {
        Estadi::create(['nom' => 'Camp Nou',            'capacitat' => 99000]);
        Estadi::create(['nom' => 'Wanda Metropolitano', 'capacitat' => 68000]);
        Estadi::create(['nom' => 'Santiago Bernab√©u',   'capacitat' => 81000]);

        // Opcional: per comprovar que s'han creat
        dump('EstadisSeeder - despr√©s de crear:', Estadi::count());
    }
}
```

### `database/seeders/EquipsSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\Equip;
use App\Models\Estadi;
use Illuminate\Database\Seeder;

class EquipsSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Opcional: missatge de depuraci√≥
        dump('EquipsSeeder: abans de crear', [
            'estadis' => Estadi::count(),
            'equips'  => Equip::count(),
        ]);

        // Assegurem que els 3 estadis principals existeixen
        $campNou = Estadi::firstOrCreate(
            ['nom' => 'Camp Nou'],
            ['capacitat' => 99000]
        );

        $wanda = Estadi::firstOrCreate(
            ['nom' => 'Wanda Metropolitano'],
            ['capacitat' => 68000]
        );

        $bernabeu = Estadi::firstOrCreate(
            ['nom' => 'Santiago Bernab√©u'],
            ['capacitat' => 81000]
        );

        // Crear equips ‚Äúa m√†‚Äù amb relaci√≥
        $campNou->equips()->firstOrCreate(
            ['nom' => 'Bar√ßa Femen√≠'],
            ['titols' => 30]
        );

        $wanda->equips()->firstOrCreate(
            ['nom' => 'Atl√®tic de Madrid'],
            ['titols' => 10]
        );

        $bernabeu->equips()->firstOrCreate(
            ['nom' => 'Real Madrid Femen√≠'],
            ['titols' => 5]
        );

        // Crear 10 equips m√©s usant la factory
        Equip::factory()->count(10)->create();

        // Opcional: comprovar resultats
        dump('EquipsSeeder: despr√©s de crear', [
            'estadis' => Estadi::count(),
            'equips'  => Equip::count(),
        ]);
    }
}
```

---

## 2.5. Completar el `DatabaseSeeder`

Aquest √©s el seeder ‚Äúprincipal‚Äù que Laravel executa quan fem `db:seed` o `migrate:fresh --seed`.

### `database/seeders/DatabaseSeeder.php`

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        // Des d'ac√≠ cridem la resta de seeders
        $this->call([
            EstadisSeeder::class,
            EquipsSeeder::class,
        ]);

        // Opcional: per veure que acaba
        dump('DatabaseSeeder: FIN');
    }
}
```

> üî¥ Nota important:
> 
> En la plantilla original de Laravel tamb√© es creava un usuari de prova amb `test@example.com`.
> Aix√≤ pot donar problemes de clau √∫nica (`Duplicate entry`) si executes `db:seed` diverses vegades.
> Per a aquesta pr√†ctica **hem eliminat** la creaci√≥ de l‚Äôusuari per simplificar.

---

## 2.6. Executar els Seeders i Factories

### 2.6.1. Executar tots els seeders (via `DatabaseSeeder`)

```bash
make artisan CMD="db:seed"
```

Aix√≤ executa:

1. `DatabaseSeeder::run()`
2. Que al seu torn crida:
   - `EstadisSeeder`
   - `EquipsSeeder`

### 2.6.2. Executar un seeder concret

Per exemple, nom√©s `EquipsSeeder`:

```bash
make artisan CMD="db:seed --class=EquipsSeeder"
```

√ötil per a provar nom√©s una part sense tocar la resta.

### 2.6.3. `migrate:fresh --seed` (tot des de zero)

```bash
make artisan CMD="migrate:fresh --seed"
```

Qu√® fa exactament?

1. **Dropping all tables** ‚Üí Esborra TOTES les taules de la base de dades.
2. **Running migrations** ‚Üí Torna a crear les taules des de les migracions.
3. **Seeding database** ‚Üí Executa `DatabaseSeeder` (i per tant `EstadisSeeder` i `EquipsSeeder`).

√âs el ‚Äúreset complet‚Äù ideal en desenvolupament: 
et deixa la BBDD neta i reomplida amb dades d‚Äôexemple.

---

## 2.7. Comprovaci√≥ amb Tinker (opcional per√≤ recomanable)

Despr√©s de fer `migrate:fresh --seed`, podem comprovar:

```bash
make artisan CMD="tinker"
```

Dins de Tinker:

```php
>>> \App\Models\Estadi::count();        // quants estadis hi ha?
>>> \App\Models\Equip::count();         // quants equips hi ha?
>>> \App\Models\Estadi::with('equips')->get(); // estadis + equips relacionats
```

Si tot est√† correcte, veureu:

- 3 estadis ‚Äúfamosos‚Äù (Camp Nou, Wanda, Bernab√©u)
- + uns quants estadis extra creats per les factories
- equips creats a m√† + equips creats per `EquipFactory`

---

## 2.8. Errors t√≠pics que hem evitat amb aquests canvis

- ‚ùå **No cridar els seeders des de `DatabaseSeeder`** 
  ‚Üí `db:seed` no faria res. 
  ‚úîÔ∏è Soluci√≥: afegir-los a `$this->call([...])`.

- ‚ùå **Duplicar usuaris de prova (`test@example.com`)** 
  ‚Üí error de `Duplicate entry` si es creava sempre el mateix usuari. 
  ‚úîÔ∏è Soluci√≥: per a aquesta pr√†ctica, hem eliminat l‚Äôusuari de prova.

- ‚ùå **Models sense `HasFactory` o sense relacions** 
  ‚Üí `Model::factory()` no existeix, o `$estadi->equips()` d√≥na error. 
  ‚úîÔ∏è Soluci√≥: afegir `use HasFactory;` i definir `equips()` / `estadi()` als models.

Amb aquest esquema, si seguiu els passos en ordre, 
`db:seed` i `migrate:fresh --seed` funcionaran sense errors üéâ